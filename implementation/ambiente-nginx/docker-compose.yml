version: '2'

services:
  # Nginx Load Balancer
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx_load_balancer
  #   ports:
  #     - "80:80" # Porta onde o Nginx irá ouvir
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf # Arquivo de configuração do Nginx
  #   depends_on:
  #     - reserve01
  #     - reserve02
  #     - reserve03
  #     - reserve04
  #     - reserve05
  #     - auth_service
  #     - evento_service
  #     - payment_service
  #   deploy:
  #     resources:
  #       limits: 
  #         cpus: '0.10'
  #         memory: '0.5GB'
  #   network_mode: host

  # cadvisor:
  #   container_name: cadvisor
  #   image: gcr.io/cadvisor/cadvisor:latest
  #   ports:
  #     - "8080:8080"
  #   volumes: 
  #     - "/:/rootfs"
  #     - "/var/run:/var/run"
  #     - "/sys:/sys"
  #     - "/var/lib/docker/:/var/lib/docker"
  #     - "/dev/disk/:/dev/disk"
  #   privileged: true
  #   devices: 
  #     - "/dev/kmsg"

  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: prometheus
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml
  #     - ./alert.rules.yml:/etc/prometheus/alert.rules.yml  # Volume para o arquivo de regras de alerta
  #   depends_on:
  #     - cadvisor
  #     - alertmanager

  # flask_server:
  #   build:
  #     context: ./container-servico-scaleflask
  #     dockerfile: Dockerfile
  #   container_name: flask_server
  #   ports:
  #     - "10000:10000"  # Porta exposta para o servidor Flask
  #   volumes:
  #     - ./script_de_escalonamento.sh:/app/script_de_escalonamento.sh  # Volume para o script de escalonamento
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   environment:
  #     - DOCKER_HOST=unix:///var/run/docker.sock
  #   depends_on:
  #     - cadvisor
  #     - alertmanager
  #     - prometheus

  # alertmanager:
  #   image: prom/alertmanager
  #   container_name: alertmanager
  #   ports:
  #     - "9093:9093"
  #   volumes:
  #     - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml

  kong:
    image: kong:3.1
    container_name: kong
    ports:
      - "8000:8000"
      - "8443:8443"
    environment:
      KONG_DATABASE: "off"
      KONG_PROXY_LISTENER: "0.0.0.0:8000"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
    volumes:
      - ./kong.yml:/etc/kong/kong.yml
    depends_on:
      - auth_service
      - evento_service
      - payment_service
      - reserve_service

  auth_service:
    build:
      context: ./container-servico-auth
      dockerfile: Dockerfile
    image: ticket-safe:auth-service-latest
    environment:
      - PORT=5000
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - PG_HOST=localhost
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DATABASE=reservas
    ports:
      - "5000:5000"
    depends_on:
      - postgres
      - redis

  evento_service:
    build:
      context: ./container-servico-eventos
      dockerfile: Dockerfile
    image: ticket-safe:evento-service-latest
    environment:
      - PORT=5001
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - PG_HOST=localhost
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DATABASE=reservas
    ports:
      - "5001:5001"
    depends_on:
      - postgres
      - redis

  payment_service:
    build:
      context: ./container-servico-pagamento
      dockerfile: Dockerfile
    image: ticket-safe:payment-service-latest
    environment:
      - PORT=5002
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - PG_HOST=localhost
      - PG_PORT=5432
      - PG_USER=user
      - PG_PASSWORD=password
      - PG_DATABASE=reservas
    ports:
      - "5002:5002"
    depends_on:
      - postgres
      - redis

  reserve_service:
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9501
     


  # PostgreSQL Service
  postgres:
    image: postgres:13
    container_name: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: reservas
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql  # Script de inicialização
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '1.0GB'
    network_mode: host          
    

  # Redis Service
  redis:
    build:
      context: ./container-servico-redis
      dockerfile: Dockerfile
    container_name: redis
    image: ticket-safe:redis-sync-latest
    ports:
      - "6379:6379"
    environment:
      PG_HOST: localhost 
      PG_PORT: 5432
      PG_USER: user
      PG_PASSWORD: password
      PG_DATABASE: reservas
      REDIS_HOST: localhost
      REDIS_PORT: 6379
    volumes:
      - redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: '0.5GB'
    depends_on:
      - postgres
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done;
      redis-server /usr/local/etc/redis/redis.conf"
    network_mode: host          
    



  # Auth Service
  auth_service:
    hostname: auth_service
    build:
      context: ./container-servico-auth
      dockerfile: Dockerfile
    image: ticket-safe:auth-service-latest
    environment:
      - PORT=5000
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    ports:
      - "5000:5000"
    depends_on:
      - postgres
      - redis
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    


  # Evento Service
  evento_service:
    hostname: evento_service
    build:
      context: ./container-servico-eventos
      dockerfile: Dockerfile  
    image: ticket-safe:evento-service-latest
    environment:
      - PORT=5001
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    ports:
      - "5001:5001"
    depends_on:
      - postgres
      - redis
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    


  # Payment Service
  payment_service:
    hostname: payment_service
    build:
      context: ./container-servico-pagamento
      dockerfile: Dockerfile
    image: ticket-safe:payment-service-latest
    environment:
      - PORT=5002
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    ports:
      - "5002:5002"
    depends_on:
      - postgres
      - redis    
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    


  # Reserve Service01
  reserve01:
    hostname: reserve01
    container_name: reserve01
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9501
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
      - CLUSTER=true
      - CLUSTER_WORKERS=6
    depends_on:
      - postgres
      - redis
    ports:
      - "9501:9501"      
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '0.5GB'
    network_mode: host          
    



  # Reserve Service01
  reserve02:
    hostname: reserve02
    container_name: reserve02
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9502
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
      - CLUSTER=true
      - CLUSTER_WORKERS=6
    depends_on:
      - postgres
      - redis
    ports:
      - "9502:9502"      
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '0.5GB'
    network_mode: host          
    



  # Reserve Service01
  reserve03:
    hostname: reserve03
    container_name: reserve03
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9503
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço Po9501stgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
      - CLUSTER=true
      - CLUSTER_WORKERS=6
    depends_on:
      - postgres
      - redis
    ports:
      - "9503:9503"      
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '0.5GB'
    network_mode: host          
    

  # Reserve Service01
  reserve04:
    hostname: reserve04
    container_name: reserve04
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9504
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço Po9501stgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
      - CLUSTER=true
      - CLUSTER_WORKERS=6
    depends_on:
      - postgres
      - redis
    ports:
      - "9504:9504"      
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '0.5GB'
    network_mode: host          
    


  # Reserve Service01
  reserve05:
    hostname: reserve05
    container_name: reserve05
    build:
      context: ./container-servico-reserva
      dockerfile: Dockerfile
    image: ticket-safe:reserve-service-latest
    environment:
      - PORT=9505
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço Po9501stgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
      - CLUSTER=true
      - CLUSTER_WORKERS=6
    depends_on:
      - postgres
      - redis
    ports:
      - "9505:9505"      
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: '0.5GB'
    network_mode: host          
    




    
  # Worker Cancel Service
  worker_cancel:
    build:
      context: ./container-servico-workercancel
      dockerfile: Dockerfile  
    image: ticket-safe:cancel-worker-latest
    environment:
      - PORT=5003
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    depends_on:
      - postgres
      - redis 
    ports:
      - "5003:5003"           
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    


  # Worker Confirmation Service
  worker_confirmation:
    build:
      context: ./container-servico-workerconfirm
      dockerfile: Dockerfile  
    image: ticket-safe:confirmation-worker-latest
    environment:
      - PORT=5004
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    depends_on:
      - postgres
      - redis    
    ports:
      - "5004:5004"         
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    


  # Worker save reserve
  worker-save-reserve:
    build:
      context: ./container-servico-workerSaveReserve
      dockerfile: Dockerfile  
    image: ticket-safe:save-worker-latest
    environment:
      - PORT=5005
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    depends_on:
      - postgres
      - redis    
    ports:
      - "5005:5005"       
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    

  # Worker Sync Service
  worker_sync:
    build:
      context: ./container-servico-workersync
      dockerfile: Dockerfile
    image: ticket-safe:sync-service-latest
    environment:
      - PORT=5006
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    depends_on:
      - postgres
      - redis    
    ports:
      - "5006:5006"        
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          

  # Worker process Reserve 
  worker-reserve:
    build:
      context: ./container-servico-workerReserve
      dockerfile: Dockerfile  
    image: ticket-safe:reserve-worker-latest
    environment:
      - PORT=5007
      - REDIS_HOST=localhost       # Nome do serviço Redis definido no docker-compose
      - REDIS_PORT=6379               # Porta do Redis
      - PG_HOST=localhost      # Nome do serviço PostgreSQL definido no docker-compose
      - PG_PORT=5432                  # Porta do PostgreSQL
      - PG_USER=user                  # Nome do usuário do PostgreSQL
      - PG_PASSWORD=password          # Senha do PostgreSQL
      - PG_DATABASE=reservas          # Nome do banco de dados
      - JWT_SECRET=ticketsafejwt      # Segredo JWT (troque por um valor seguro em produção)
    depends_on:
      - postgres
      - redis    
    ports:
      - "5007:5007"       
    command: >
      bash -c "until nc -z -v -w30 localhost 5432; do echo 'Waiting for PostgreSQL...'; sleep 5; done; npm start"
    deploy:
      resources:
        limits:
          cpus: '0.03'
          memory: '0.2GB'
    network_mode: host          
    

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
